title: 读书笔记之亿级流量网站架构核心技术  
tags: [读书笔记]   
date:2017-9-11  

---  

本文只是简单记录书中自认为重要的内容，详细内容请查看张开涛老师的《亿级流量网站架构核心技术》一书

### 负载均衡 ###  
广泛的负载均衡软件有Nginx,LVS,HAproxy  
二层负载均衡是通过改写报文的目标MAC地址为上游服务器MAC地址，源IP地址和目标IP地址是没有变的，负载均衡服务器和真实服务器共享同一个VIP(LVS DR模式)  
四层负载均衡是根据端口将报文转发到上游服务器（不同的IP地址+端口），如LVS NAT模式、HAProxy  
七层负载均衡是根据端口号和应用层协议如HTTP协议的主机名、URL、转发报文到上游服务器（不同的IP地址+端口），如HAProxy、Nginx  
Nginx从1.9.0开始支持四层负载均衡  

### HTTP反向代理 ###  
反向代理除了实现负载均衡之外，还提供如缓存来减少上游服务器的压力

### HTTP动态负载均衡 ###  
Consul是一款开源的分布式服务注册与发现系统  

### 隔离 ###
Hystrix是Netflix开源的一款针对分布式系统的延迟和容错库，目的是用来隔离分布式服务故障  
Servlet3请求异步：请求解析和业务处理线程池分离  
异步化并不会提升响应时间，但会增加吞吐量和我们需要的灵活性  

### 限流 ###  
限流的目的是通过对并发访问/请求进行限速或者一个时间窗口内的请求进行限速来保护系统，一旦达到限制速率则可以拒绝服务、排队或等待、降级  

开发高并发系统最常见的限流有：限制总并发数、限制瞬时并发数、限制时间窗口内的平均速率，以及限制远程接口调用速率、限制MQ的消费速率

#### 限流算法  ####
令牌桶算法和漏桶算法  
#### Nginx limit_conn主要执行过程 ####
1. 请求进入后首先判断当前limit_conn_zone中相应key的连接数是否超出了配置的最大连接数  
2. 如果超过了配置的最大大小，则被限流，返回limit_conn_status定义的错误状态码。否则相应key的连接数加1，并注册请求处理完成的回掉函数  
3. 进行请求处理  
4. 在结束请求阶段会调用注册的总并发/请求数，key可以根据需求变化  

AtomicLong：可以用原子方式更新的 long 值  

### 节流 ###  
节流（Throttle):防止多个相同事件连续重复执行  
节流主要有如下几种用法：throttleFirst,throttleLast,throttleWithTimeout  
throttleFirst/throttleLast：在一个时间窗口内，如果有重复的多个相同事件要处理，则只处理第一个或最后一个。  
throttleWithTimeout也叫debounce(去抖)，限制两个连续事件的先后执行时间不得小于某个时间窗口  

### 降级 ###  
降级的最终目的是保证核心服务可用，即使是有损的  
降级可以分为自动降级，人工降级  
缓存是离用户越近越高效，而降级是离用户越近对系统保护得好  

### 超时与重试机制 ###  
如果应用不设置超时，可能会导致请求响应慢，慢请求累计导致连锁反应，甚至造成应用雪崩。  
超时与重试机制一般应用在下面几类：
1. 代理层超时与重试（Nginx，Haproxy等）  
2. Web容器超时(Tomcat，Jetty等)  
3. 中间件客户端超时与重试(Dubbo,MQ等)  
4. 数据库客户端超时（MySQL,Oracle等）  
5. NoSQL客户端超时（Redis,Mongo等）  
6. 业务超时  
7. 前段Ajax超时  

#### 代理层超时与重试 ####
Nginx主要有四类超时重试：客户端超时设置、DNS解析超时设置、代理超时设置、如果使用ngx_lua，还有Lua相关的超时设置  
http/1.0默认是关闭长连接的，需要添加HTTP请求头“connection:keep-alive”才能启用。而http/1.1默认启用长连接，需要添加HTTP请求头“Connection:close”进行关闭  
keepalive_requests:一个客户端可以通过此长连接的请求次数，默认是100。  
#### NoSQL客户端超时 ####  
除了在NoSQL客户端配置中设置超时外，还可以在JVM启动时通过添加-Dsun.net.client.defaultConnectTimeout=60000-Dsun.net.client.defaultReadTimeout=60000来配置默认的全局Socket连接/读超时。即如HttpClient、JDBC等，如果没有配置Socket超时，则会默认使用该超时。  

#### 业务超时 ####  
业务超时可以分为如下两类：  
任务型
服务调用型  
对于非幂等写服务应避免重试，或者可以考虑提前生成唯一流水号来保证写服务操作通过判断流水号来实现幂等操作  
对于有负载均衡的中间件，请考虑配置心跳/存活检查，而不是惰性检查  

### 回滚机制 ###  
最常见的回滚机制有：事务回滚、代码库回滚、部署版本回滚、数据版本回滚、静态资源版本回滚等。通过回滚机制可保证系统在某些场景下的高可用  
#### 事务回滚 ####  
单库事务回滚比较简单，直接使用SQL即可。分布式事务回滚难度较低，但是对性能影响较大。因为我们在大多数场景中需要的是最终一致性，而不是强一致性。因此可以考虑如事务表、消息队列、补偿机制(执行/回滚)、TCC模式（预占/确认/取消）、Sagas模式（拆分事务+补偿机制）等实现最终一致性。  

### 压测与预案 ###  
压测一般指性能压力测试，用来评估系统的稳定性和性能，通过呀测数据进行系统容量评估，从而决定是否需要进行扩容和缩容。  
